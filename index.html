let searchTerm = '';
let staffMapping = {};

async function loadStaffMapping() {
    try {
        const response = await fetch('staff.csv?cachebust=' + new Date().getTime(), {
            cache: 'no-store'
        });
        
        if (!response.ok) {
            console.warn('Could not load staff.csv, using original names');
            return;
        }

        const text = await response.text();
        const lines = text.trim().split(/[\r\n]+/);
        
        if (lines.length < 2) return;
        
        const headers = lines[0].split(',');
        const initialIdx = headers.indexOf('initial');
        const fnameIdx = headers.indexOf('fname');
        const lnameIdx = headers.indexOf('lname');
        
        if (initialIdx === -1 || fnameIdx === -1 || lnameIdx === -1) {
            console.warn('staff.csv missing required columns');
            return;
        }
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;
            
            const values = line.split(',');
            if (values.length <= Math.max(initialIdx, fnameIdx, lnameIdx)) continue;
            
            const initial = values[initialIdx].trim();
            const fname = values[fnameIdx].trim();
            const lname = values[lnameIdx].trim();
            
            if (initial && fname && lname) {
                const firstInitial = fname.charAt(0).toUpperCase();
                staffMapping[initial] = `${firstInitial} ${lname}`;
            }
        }
    } catch (error) {
        console.warn('Error loading staff mapping:', error);
    }
}

function formatTeacherName(teacherCode) {
    return staffMapping[teacherCode] || teacherCode;
}

async function loadDataAndRun() {
    try {
        // Load staff mapping first
        await loadStaffMapping();
        
        const response = await fetch('Lessons.tsv?cachebust=' + new Date().getTime(), {
            cache: 'no-store'
        });
